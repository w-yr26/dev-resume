# PDF分页导出技术实现方案演进
1. **背景** 在现有的简历网站中，主要有以下几种实现方案：低代码拖拽、`markdown`渲染、`JSON`数据驱动模板渲染。项目中采用第三种方案，并且初期使用的是`canvas2dom`+`pdfjs`的方案实现`pdf`导出
2. 该方案的本质是先将目标DOM转成canvas图片，再植入pdf中，但遇到了两个本质性限制：
   * 高质量的导出效果依赖于高质量的canvas图像，但浏览器对canvas是存在大小限制的
   * pdf导出不可忽略的一个场景是**分页导出**。由于采用的是JSON驱动模板渲染的方案，所以想到递归时计算各节点位置从而判断是否分页，但动态计算分页存在一些致命问题：
      1. 递归过程中无法准确预判模块跨页时的打断位置，是行级打断还是模块级别的打断
      2. 实习经历等动态内容可能会导致最后一页仅残留半行文本，动态高度计算实现复杂
      3. 对于同一行但不同模块的内容，由于所处高度相同，还要避免做重复计算
3. 于是进行了一次实现方案的迭代，主要受`Canvas可画`的启发，它是一个拖拽式的简历制作网站，但是它在分页时是**用户主导**的
    * 在项目中全局维护一个`Map`来表示`page`与`moduleArray`的映射关系，`key`表示当前页，`moduleArray`表示当前页内需要渲染的模块
    * 并提供页面管理面板，支持用户动态增删简历页数、模块跨页拖拽排序
    * 在渲染简历数据时，换成遍历`Map`的每一页，生成各自独立的`DOM`树，规避动态计算的问题
4. 但仍然遗留了几个问题：导出质量与`canvas`大小限制的矛盾、生成`canvas`时一些默认样式的丢失
5. 于是考虑其他实现方案，主要包括：
    * 浏览器打印，实现技术成本低，但是需要用户手动交互打印的过程，作为`Toc`的网站，这种实现方案不够完美，且存在**色彩失真** (主要是简历上的照片)
    * 无头浏览器打印，将目标打印内容的`html`+`css`内容传递给服务端，服务端通过无头浏览器模拟渲染，返回二进制文件，前端进行下载。这种方案导出的结果精度高，且不受限于浏览器，自动化程度高，最终采用了这种方案。考虑到安全性，做了一些安全防御的工作，主要包括：
      1. 标签过滤，服务端过滤非安全标签防止`XSS`攻击
      2. **加盐**`hash`加密，防止目标打印内容被篡改
      3. `CSP`策略，阻断无头浏览器加载外部其他资源
